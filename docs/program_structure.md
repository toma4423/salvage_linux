# USBブートLinux GUIディスクユーティリティ - プログラム構造図解

## 1. プログラムの構成要素

```
+----------------------------+
|   DiskUtilityApp (GUI)     |     メイン画面と操作部分
+------------+---------------+
             |
             | 使用する
             v
+------------+---------------+
|    DiskUtils               |     ディスク操作の実行部分
+------------+---------------+
             |
             | 記録する        使用する
             v                 v
+------------+------+   +-----+----------------+
|    Logger         |   |    ConfigManager     |
+-------------------+   +----------------------+
     操作記録部分              設定管理部分

                             +-------------------+
                             |   SettingsDialog  |     設定画面
                             +-------------------+
```

## 2. ファイル構成

```
salvage_linux/
│
├── src/                      # ソースコード
│   ├── main.py               # メインプログラム
│   ├── disk_utils.py         # ディスク操作機能
│   ├── logger.py             # 操作記録機能
│   ├── config_manager.py     # 設定管理機能
│   ├── settings.py           # 設定画面
│   └── version.py            # バージョン情報
│
├── docs/                     # 資料
│   ├── program_guide.md      # プログラム解説資料
│   └── program_structure.md  # プログラム構造図解
│
└── (その他のファイル)
```

## 3. 処理の流れ（メイン画面）

```
  +--------------------+
  | プログラム起動      |
  +----------+---------+
             |
             v
  +----------+---------+
  | ConfigManagerを作成 |
  +----------+---------+
             |
             v
  +----------+---------+
  |   Loggerを作成     |
  +----------+---------+
             |
             v
  +----------+---------+
  | DiskUtilsを作成    |
  +----------+---------+
             |
             v
  +----------+---------+
  |  画面の部品を配置   |
  +----------+---------+
             |
             v
  +----------+---------+
  | ディスク一覧を表示  |
  +----------+---------+
             |
             v
  +----------+---------+
  | ユーザーの操作を待つ |
  +----------+---------+
```

## 4. 処理の流れ（ディスクのマウント）

```
  +--------------------+
  | ディスクを選択      |
  +----------+---------+
             |
             v
  +----------+---------+
  | 「マウント」をクリック |
  +----------+---------+
             |
             v
  +----------+---------+
  | _mount_selected_disk()を呼び出し |
  +----------+---------+
             |
             v
  +----------+---------+
  | 別スレッドでマウント処理 |
  +----------+---------+
             |
             v
  +----------+---------+       +------------------+
  | マウント成功？    +--No----> エラーメッセージ表示 |
  +----------+---------+       +------------------+
             |                          |
            Yes                         |
             |                          |
             v                          v
  +----------+---------+       +------------------+
  | 成功メッセージ表示   |       |   ログに記録     |
  +----------+---------+       +------------------+
             |                          |
             v                          |
  +----------+---------+                |
  | ディスク一覧を更新   |<---------------+
  +----------+---------+
```

## 5. 処理の流れ（設定変更）

```
  +--------------------+
  | 「設定」をクリック   |
  +----------+---------+
             |
             v
  +----------+---------+
  | SettingsDialogを作成 |
  +----------+---------+
             |
             v
  +----------+---------+
  | 設定画面を表示     |
  +----------+---------+
             |
             v
  +----------+---------+
  | 設定を変更         |
  +----------+---------+
             |
             v
  +----------+---------+       +------------------+
  | 「保存」をクリック  +--No----> キャンセル        |
  +----------+---------+       +------------------+
             |                          |
            Yes                         |
             |                          |
             v                          |
  +----------+---------+                |
  | 設定を保存         |                |
  +----------+---------+                |
             |                          |
             v                          v
  +----------+---------+       +------------------+
  | 設定画面を閉じる    |------>| メイン画面に戻る   |
  +----------+---------+       +------------------+
```

## 6. クラスと主要関数

### DiskUtilityApp（メイン画面）

```
DiskUtilityApp
├── __init__()        - 初期化
├── _build_gui()      - 画面の部品を配置
├── _refresh_disk_lists() - ディスク一覧を更新
├── _mount_selected_disk() - ディスクをマウント
├── _format_selected_disk() - ディスクをフォーマット
├── _open_selected_disk() - ファイルマネージャーで開く
└── _set_permissions_to_selected_disk() - 権限を設定
```

### DiskUtils（ディスク操作）

```
DiskUtils
├── __init__()           - 初期化
├── get_unmounted_disks() - 未マウントディスク一覧を取得
├── get_mounted_disks()   - マウント済みディスク一覧を取得
├── mount_disk()          - ディスクをマウント
├── format_disk()         - ディスクをフォーマット
├── set_permissions()     - 権限を設定
└── open_file_manager()   - ファイルマネージャーで開く
```

### Logger（操作記録）

```
Logger
├── __init__()     - 初期化
├── debug()        - デバッグ情報を記録
├── info()         - 情報を記録
├── warning()      - 警告を記録
├── error()        - エラーを記録
└── critical()     - 重大エラーを記録
```

### ConfigManager（設定管理）

```
ConfigManager
├── __init__()     - 初期化
├── load_config()  - 設定を読み込み
├── save_config()  - 設定を保存
├── get()          - 設定値を取得
└── set()          - 設定値を設定
```

### SettingsDialog（設定画面）

```
SettingsDialog
├── __init__()          - 初期化
├── _create_widgets()   - 画面の部品を配置
├── save_settings()     - 設定を保存
└── reset_to_defaults() - 設定を初期値に戻す
```

## 7. 設定ファイルの構造

設定は以下のようなJSON形式で保存されます：

```json
{
  "file_manager": "auto",
  "file_managers_list": [
    "xdg-open",
    "pcmanfm",
    "nautilus",
    "thunar",
    "dolphin",
    "nemo",
    "caja"
  ],
  "format_default": "exfat",
  "log_level": "INFO",
  "language": "ja"
}
```

## 8. まとめ

このプログラムは、以下の要素が連携して動作しています：

1. **画面表示と操作の管理**（DiskUtilityApp）
2. **ディスク操作の実行**（DiskUtils）
3. **操作の記録**（Logger）
4. **設定の管理**（ConfigManager）
5. **設定画面の表示**（SettingsDialog）

それぞれが独立した役割を持ちながらも、連携して動作することで、使いやすいディスクユーティリティを実現しています。 