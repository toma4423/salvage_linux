# USBブートLinux GUIディスクユーティリティ 初心者向け解説資料

## はじめに

このドキュメントでは、「USBブートLinux GUIディスクユーティリティ」というプログラムの仕組みと使われている技術について、コンピュータやプログラミングの経験が少ない方にも分かりやすく解説します。

## 1. プログラムの概要

### 1.1 このプログラムの目的

このプログラムは、USBメモリなどからLinux（コンピュータのOS）を起動した環境で、コンピュータに接続されたディスク（内蔵ハードディスクや外付けの記憶装置）を簡単に操作するためのツールです。マウス操作だけで、ディスクの接続（マウント）、初期化（フォーマット）、アクセス権限の設定などができます。

### 1.2 主な機能

- **未接続ディスクの接続（マウント）**: コンピュータに認識されているけれど、まだ使えるようになっていないディスクを使えるようにします。
- **ディスクの初期化（フォーマット）**: ディスクを特定の形式で使えるように初期化します。
- **ファイルマネージャーでの表示**: 接続済みのディスクの中身をファイル管理ソフトで表示します。
- **アクセス権限の設定**: ディスクに対して、読み書きができる権限を設定します。
- **環境に合わせた自動設定**: 使用しているLinux環境に応じて、最適な設定を自動的に選択します。
- **設定のカスタマイズ**: 様々な設定を利用者が好みに合わせて変更できます。

### 1.3 全体の構造

このプログラムは、以下の主要部分から構成されています：

1. **メイン画面（GUI）**: 利用者が見る画面と操作するボタンなどの部品
2. **ディスク操作機能**: 実際にディスクを操作する機能
3. **ログ記録機能**: 操作の記録を残す機能
4. **設定管理機能**: 利用者の設定を保存・読み込みする機能

## 2. プログラムの構成ファイル

このプログラムは複数のファイルに分かれて作られています。各ファイルには特定の役割があります。

### 2.1 src/main.py
画面表示と利用者の操作を受け付ける中心的な部分です。プログラムを起動すると最初に実行されるファイルです。

### 2.2 src/disk_utils.py
ディスクの操作（接続、初期化、権限設定など）を行う機能が集まったファイルです。

### 2.3 src/logger.py
プログラムの動作記録（ログ）を残す機能が入ったファイルです。エラーが発生した場合の調査に役立ちます。

### 2.4 src/config_manager.py
利用者の設定を管理する機能が入ったファイルです。設定の保存や読み込みを担当します。

### 2.5 src/settings.py
設定画面を表示し、設定の変更を行う機能が入ったファイルです。

### 2.6 src/version.py
プログラムのバージョン情報を管理するファイルです。

## 3. 主要な機能と処理の流れ

### 3.1 プログラムの起動から画面表示まで

1. ユーザーがプログラムを実行すると、`main.py`の`main()`関数が呼び出されます。
2. Tkinterというライブラリを使って、メインウィンドウが作られます。
3. `DiskUtilityApp`クラスが初期化され、画面の部品（ボタンやリストなど）が配置されます。
4. 設定ファイルが読み込まれ、前回の設定が適用されます。
5. ディスクの一覧が取得され、画面に表示されます。

### 3.2 ディスク一覧の表示

1. `_refresh_disk_lists()`関数が呼び出されます。
2. `DiskUtils`クラスの`get_unmounted_disks()`と`get_mounted_disks()`関数が実行されます。
3. これらの関数は内部でLinuxのコマンド（lsblkなど）を実行して、ディスク情報を取得します。
4. 取得した情報を画面上のリストボックスに表示します。

### 3.3 ディスクのマウント（接続）

1. ユーザーが未マウントディスク一覧から項目を選び、「マウント」ボタンをクリックします。
2. `_mount_selected_disk()`関数が呼び出されます。
3. 別のスレッド（同時進行の処理）で`mount_thread()`関数が実行されます。
4. `DiskUtils`クラスの`mount_disk()`関数が呼び出され、実際のマウント処理が実行されます。
5. 処理の結果（成功/失敗）に応じてメッセージが表示されます。
6. ディスク一覧が更新されます。

### 3.4 ディスクのフォーマット（初期化）

1. ユーザーが未マウントディスク一覧から項目を選び、「フォーマット」ボタンをクリックします。
2. `_format_selected_disk()`関数が呼び出されます。
3. 別のスレッドで`format_thread()`関数が実行されます。
4. `DiskUtils`クラスの`format_disk()`関数が呼び出され、実際のフォーマット処理が実行されます。
5. 処理の結果に応じてメッセージが表示されます。
6. ディスク一覧が更新されます。

### 3.5 ファイルマネージャーでの表示

1. ユーザーがマウント済みディスク一覧から項目を選び、「開く」ボタンをクリックします。
2. `_open_selected_disk()`関数が呼び出されます。
3. `DiskUtils`クラスの`open_file_manager()`関数が呼び出されます。
4. 環境に合わせて適切なファイルマネージャーが選択され、ディスクの内容が表示されます。

### 3.6 権限の付与

1. ユーザーがマウント済みディスク一覧から項目を選び、「権限付与」ボタンをクリックします。
2. `_set_permissions_to_selected_disk()`関数が呼び出されます。
3. 別のスレッドで`permission_thread()`関数が実行されます。
4. `DiskUtils`クラスの`set_permissions()`関数が呼び出され、実際の権限設定処理が実行されます。
5. 処理の結果に応じてメッセージが表示されます。

### 3.7 設定の変更

1. ユーザーがメニューから「設定」を選択するか、設定ボタンをクリックします。
2. `open_settings_dialog()`関数が呼び出されます。
3. `SettingsDialog`クラスが初期化され、設定画面が表示されます。
4. ユーザーが設定を変更し、「保存」ボタンをクリックすると、設定が保存されます。
5. 設定内容は`ConfigManager`クラスによって管理され、JSONファイルとして保存されます。

## 4. 主要な関数と処理の詳細説明

### 4.1 メイン画面とGUI関連（DiskUtilityAppクラス）

#### `__init__(root, test_mode=False)`
プログラム起動時に最初に呼ばれる初期化関数です。画面の基本設定や必要なオブジェクトの作成を行います。
- `root`: 画面の基本となるウィンドウです。
- `test_mode`: テスト用のモードかどうかを指定します。

#### `_build_gui()`
画面の部品（ボタン、リスト、ラベルなど）を配置する関数です。
- 画面のレイアウトを設定し、各部品を適切な位置に配置します。
- 部品の大きさや配置を調整し、画面サイズが変わっても見やすいようにします。

#### `_refresh_disk_lists()`
ディスクの一覧を更新する関数です。
- 未マウントディスクとマウント済みディスクの情報を取得し、画面に表示します。
- 画面の状態（ボタンの有効/無効など）も更新します。

#### `_on_unmounted_disk_select(event)` / `_on_mounted_disk_select(event)`
ディスク一覧から項目が選択されたときに呼ばれる関数です。
- 選択されたディスクの情報を表示します。
- 操作可能なボタンを有効にします。

#### `_mount_selected_disk()` / `_format_selected_disk()` / `_open_selected_disk()` / `_set_permissions_to_selected_disk()`
各操作ボタンが押されたときに呼ばれる関数です。
- 対応する処理（マウント、フォーマット、ファイルマネージャーでの表示、権限付与）を実行します。
- 処理が時間のかかる場合は、別のスレッドで実行して画面の応答性を維持します。

### 4.2 ディスク操作関連（DiskUtilsクラス）

#### `__init__(logger, config_manager=None)`
DiskUtilsクラスの初期化関数です。
- `logger`: 操作記録を残すためのLoggerオブジェクトです。
- `config_manager`: 設定を管理するConfigManagerオブジェクトです。

#### `get_unmounted_disks()`
まだマウントされていないディスクの一覧を取得する関数です。
- Linuxのコマンドを実行して、未マウントのディスク情報を取得します。
- 取得した情報を整理して、利用しやすい形式で返します。

#### `get_mounted_disks()`
既にマウントされているディスクの一覧を取得する関数です。
- Linuxのコマンドを実行して、マウント済みのディスク情報を取得します。
- 取得した情報を整理して、利用しやすい形式で返します。

#### `mount_disk(device_path, mount_point=None)`
指定したディスクをマウント（接続）する関数です。
- `device_path`: マウントするディスクのパス（例: /dev/sdb1）
- `mount_point`: マウント先のパス。指定がない場合は自動生成します。

#### `format_disk(device_path, fs_type="exfat")`
指定したディスクをフォーマット（初期化）する関数です。
- `device_path`: フォーマットするディスクのパス
- `fs_type`: ファイルシステムの種類（exfat, vfat, ntfs, ext4など）

#### `set_permissions(mount_point)`
指定したマウントポイントに対して権限を設定する関数です。
- `mount_point`: 権限を設定するマウントポイントのパス
- chmod 777 コマンドを実行して、すべてのユーザーに読み書き実行権限を付与します。

#### `open_file_manager(mount_point)`
マウントポイントをファイルマネージャーで開く関数です。
- `mount_point`: 開くマウントポイントのパス
- 環境に合わせて適切なファイルマネージャーを自動的に選択します。

### 4.3 ログ記録関連（Loggerクラス）

#### `__init__(log_dir='logs', level=logging.INFO)`
Loggerクラスの初期化関数です。
- `log_dir`: ログファイルを保存するディレクトリ
- `level`: ログレベル（どの程度詳細なログを記録するか）

#### `info(message)` / `warning(message)` / `error(message)` / `critical(message)` / `debug(message)`
各種レベルのログを記録する関数です。
- `message`: 記録するメッセージ
- 情報・警告・エラー・重大エラー・詳細情報の各レベルに応じたログを記録します。

#### `setLevel(level)`
ログレベルを変更する関数です。
- `level`: 新たに設定するログレベル

### 4.4 設定管理関連（ConfigManagerクラス）

#### `__init__(config_dir=None)`
ConfigManagerクラスの初期化関数です。
- `config_dir`: 設定ファイルを保存するディレクトリ

#### `load_config()`
設定ファイルから設定を読み込む関数です。
- JSONファイルから設定を読み込み、メモリ上に展開します。

#### `save_config()`
現在の設定をファイルに保存する関数です。
- メモリ上の設定をJSONファイルとして保存します。

#### `get(key, default=None)` / `set(key, value)`
設定値を取得/設定する関数です。
- `key`: 設定項目のキー
- `value`: 設定する値
- `default`: 設定が存在しない場合のデフォルト値

#### `get_file_manager()` / `set_file_manager(file_manager)`
ファイルマネージャーの設定を取得/設定する関数です。
- 「自動」モードか特定のファイルマネージャーを使用するかを管理します。

### 4.5 設定画面関連（SettingsDialogクラス）

#### `__init__(parent, config_manager, logger)`
SettingsDialogクラスの初期化関数です。
- `parent`: 親ウィンドウ
- `config_manager`: 設定管理オブジェクト
- `logger`: ログ記録オブジェクト

#### `_create_widgets()`
設定画面の部品を作成し配置する関数です。
- タブ（一般設定、ファイルマネージャー、詳細設定）を作成します。
- 各種設定項目を配置します。

#### `save_settings()`
変更された設定を保存する関数です。
- ユーザーが入力した設定値を取得し、ConfigManagerを通じて保存します。

#### `reset_to_defaults()`
設定をデフォルト値にリセットする関数です。
- すべての設定を初期値に戻します。

## 5. 処理の流れの例

### 例1: プログラムの起動から画面表示まで

1. ユーザーがコマンド `sudo ./salvage_linux` を実行
2. `main.py` の `main()` 関数が実行される
3. Tkinterのルートウィンドウが作成される
4. `DiskUtilityApp` のインスタンスが作成される
5. `__init__()` 内で以下の処理が行われる:
   - `ConfigManager` のインスタンスが作成され、設定が読み込まれる
   - `Logger` のインスタンスが作成される
   - `DiskUtils` のインスタンスが作成される
   - メニューバーが作成される (`_create_menu()`)
   - GUI部品が配置される (`_build_gui()`)
   - ディスク一覧が取得・表示される (`_refresh_disk_lists()`)
6. ユーザーの操作を待つイベントループが開始される

### 例2: 未マウントディスクをマウントする流れ

1. ユーザーが左側のリストからディスクを選択
2. `_on_unmounted_disk_select()` が呼び出され、選択されたディスクの情報が表示される
3. 「マウント」ボタンが有効になる
4. ユーザーが「マウント」ボタンをクリック
5. `_mount_selected_disk()` が呼び出される
6. 別スレッドで `mount_thread()` が実行される
7. `DiskUtils.mount_disk()` が呼び出され、実際のマウント処理が行われる
8. マウント成功時:
   - 成功メッセージが表示される
   - ディスク一覧が更新される (`_refresh_disk_lists()`)
   - マウントされたディスクが右側のリストに表示される
9. マウント失敗時:
   - エラーメッセージが表示される
   - ログにエラーが記録される

### 例3: 設定を変更する流れ

1. ユーザーがメニューから「ファイル」→「設定」を選択
2. `open_settings_dialog()` が呼び出される
3. `SettingsDialog` のインスタンスが作成される
4. 設定画面が表示され、現在の設定値が表示される
5. ユーザーが設定を変更（例: ファイルマネージャーの設定を変更）
6. 「保存」ボタンをクリック
7. `save_settings()` が呼び出される
8. 変更された設定が `ConfigManager` を通じて保存される
9. 設定ダイアログが閉じる
10. 変更された設定が適用され、ディスク一覧が更新される

## 6. まとめ

このプログラムは、Linuxでのディスク操作を簡単に行えるようにするツールです。メイン画面を通じてディスクの一覧を表示し、マウント・フォーマット・権限設定などの操作をボタン一つで実行できます。また、設定画面では利用者の環境に合わせたカスタマイズも可能です。

プログラムは複数のクラスに分かれており、それぞれが特定の役割を担っています：
- `DiskUtilityApp`: 画面表示と利用者の操作を管理
- `DiskUtils`: 実際のディスク操作を実行
- `Logger`: 操作のログを記録
- `ConfigManager`: 利用者の設定を管理
- `SettingsDialog`: 設定画面を表示・管理

この資料を通じて、プログラムの基本的な仕組みと処理の流れを理解いただければ幸いです。 